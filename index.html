<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="apple-touch-icon" href="icon.png">
    <title>TASKS</title>
    <style>
        :root {
            --bg-color: #f8f8f8;
            --text-color: #4a4a4a;
            --done-color: #c0c0c0;
            --card-bg: #ffffff;
            --delete-hover: #ff7675;
            /* 莫兰迪色调 */
            --m-purple: rgb(185, 177, 202); 
            --m-red: rgb(226, 180, 180);    
            --m-orange: rgb(234, 192, 163); 
            --m-white: rgb(255, 255, 255);  
        }

        body {
            font-family: "Microsoft YaHei", -apple-system, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            padding-top: 60px;
            margin: 0;
            user-select: none;
        }

        .container {
            width: 380px;
            background: var(--card-bg);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.03);
            position: relative;
        }

        .header-container { text-align: center; margin-bottom: 5px; }
        h2 {
            display: inline-block;
            font-weight: 300;
            color: #999;
            margin: 0;
            letter-spacing: 3px;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 8px;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #ccc;
            font-size: 11px;
            margin-bottom: 25px;
            padding: 0 10px;
        }

        .data-tools span {
            cursor: pointer;
            margin-left: 12px;
            text-decoration: underline;
            text-underline-offset: 4px;
        }

        .input-group {
            display: flex;
            align-items: center;
            position: relative;
            margin-bottom: 30px;
        }

        #new-todo {
            flex: 1;
            border: 1px solid #eee;
            padding: 14px 45px 14px 18px;
            border-radius: 12px;
            outline: none;
            font-size: 14px;
            background: #fafafa;
        }

        .clear-input-btn { position: absolute; right: 15px; color: #ddd; cursor: pointer; font-size: 20px; display: none; }

        #todo-list { list-style: none; padding: 0; margin: 0; }

        .todo-item {
            display: flex;
            align-items: center;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid rgba(0,0,0,0.03);
            border-radius: 12px;
            position: relative;
            background-color: var(--m-white);
            transition: all 0.4s ease;
        }

        .todo-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: #a0a0a0;
        }

        .todo-text { flex: 1; font-size: 15px; color: var(--text-color); word-break: break-all; }
        .actions { display: flex; align-items: center; gap: 8px; margin-left: 10px; }
        .more-btn { color: #ddd; cursor: pointer; font-size: 22px; width: 24px; text-align: center; }
        .delete-btn { color: #eee; cursor: pointer; font-size: 22px; padding: 0 5px; }
        .delete-btn:hover { color: var(--delete-hover); }

        .color-menu {
            position: absolute;
            right: 10px;
            top: 50px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            display: none;
            padding: 12px;
            z-index: 100;
            gap: 12px;
            border: 1px solid #f0f0f0;
        }

        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .todo-item.completed { background-color: #fbfbfb !important; border-color: transparent; opacity: 0.5; order: 999 !important; }
        .todo-item.completed .todo-text { color: var(--done-color); text-decoration: line-through; }
        .todo-item.completed .more-btn { display: none; }

        .title-input, .edit-input { font-family: inherit; border: 1px solid #ddd; border-radius: 6px; outline: none; background: #fff; padding: 3px 8px; }
        #file-input { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-container"><h2 id="main-title">TASKS</h2></div>
    <div class="info-bar">
        <div>今日完成: <span id="done-count">0</span></div>
        <div class="data-tools">
            <span onclick="exportData()">备份</span>
            <span onclick="document.getElementById('file-input').click()">导入</span>
        </div>
    </div>
    <input type="file" id="file-input" accept=".json" onchange="importData(event)">
    <div class="input-group">
        <input type="text" id="new-todo" placeholder="记录今天的事..." autocomplete="off">
        <span class="clear-input-btn" id="clear-btn">&times;</span>
    </div>
    <ul id="todo-list" style="display: flex; flex-direction: column;"></ul>
</div>

<script>
    const input = document.getElementById('new-todo');
    const clearBtn = document.getElementById('clear-btn');
    const list = document.getElementById('todo-list');
    const mainTitle = document.getElementById('main-title');
    const doneCountDisplay = document.getElementById('done-count');

    // 优先级映射表：紫>红>橙>白
    const colorPriority = {
        "rgb(185, 177, 202)": 1, // 紫
        "rgb(226, 180, 180)": 2, // 红
        "rgb(234, 192, 163)": 3, // 橙
        "rgb(255, 255, 255)": 4  // 白
    };

    document.addEventListener('DOMContentLoaded', loadData);

    function getTodayStr() { return new Date().toISOString().split('T')[0]; }
    function updateCounter() { doneCountDisplay.innerText = document.querySelectorAll('.todo-item.completed').length; }

    // 核心自动排序函数
    function sortTasks() {
        const items = Array.from(list.children);
        items.sort((a, b) => {
            const aDone = a.classList.contains('completed');
            const bDone = b.classList.contains('completed');
            if (aDone !== bDone) return aDone ? 1 : -1;

            const aColor = a.style.backgroundColor;
            const bColor = b.style.backgroundColor;
            const pA = colorPriority[aColor] || 5;
            const pB = colorPriority[bColor] || 5;
            return pA - pB;
        });
        items.forEach(item => list.appendChild(item));
    }

    function exportData() {
        const data = localStorage.getItem('my_task_v3');
        if (!data) return alert("暂无数据");
        const blob = new Blob([data], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `TASKS_${getTodayStr()}.json`;
        a.click();
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            localStorage.setItem('my_task_v3', e.target.result);
            loadData();
        };
        reader.readAsText(file);
    }

    mainTitle.ondblclick = () => {
        const current = mainTitle.innerText;
        const ti = document.createElement('input');
        ti.value = current; ti.className = 'title-input';
        mainTitle.parentElement.replaceChild(ti, mainTitle);
        ti.focus();
        const finish = () => {
            const txt = ti.value.trim() || "TASKS";
            mainTitle.innerText = txt; document.title = txt;
            ti.parentElement.replaceChild(mainTitle, ti);
            saveData();
        };
        ti.onblur = finish;
        ti.onkeypress = (e) => { if(e.key === 'Enter') finish(); };
    };

    input.oninput = () => clearBtn.style.display = input.value.length > 0 ? 'block' : 'none';
    clearBtn.onclick = () => { input.value = ""; clearBtn.style.display = 'none'; input.focus(); };
    input.onkeypress = (e) => {
        if (e.key === 'Enter' && input.value.trim() !== "") {
            createTodoElement(input.value, false, 'var(--m-white)');
            input.value = ""; clearBtn.style.display = 'none';
            sortTasks();
            saveData();
        }
    };

    function createTodoElement(text, isDone, bgColor) {
        const li = document.createElement('li');
        li.className = `todo-item ${isDone ? 'completed' : ''}`;
        li.style.backgroundColor = bgColor;
        li.innerHTML = `
            <input type="checkbox" ${isDone ? 'checked' : ''} onchange="toggleTask(this)">
            <span class="todo-text">${text}</span>
            <div class="actions">
                <span class="more-btn" onclick="toggleColorMenu(event, this)">⋮</span>
                <span class="delete-btn" onclick="removeTask(this)">&times;</span>
            </div>
            <div class="color-menu">
                <div class="color-dot" style="background:var(--m-purple)" onclick="setTaskColor(this, 'var(--m-purple)')"></div>
                <div class="color-dot" style="background:var(--m-red)" onclick="setTaskColor(this, 'var(--m-red)')"></div>
                <div class="color-dot" style="background:var(--m-orange)" onclick="setTaskColor(this, 'var(--m-orange)')"></div>
                <div class="color-dot" style="background:var(--m-white); border:1px solid #eee" onclick="setTaskColor(this, 'var(--m-white)')"></div>
            </div>
        `;
        list.appendChild(li);
        updateCounter();
    }

    function toggleColorMenu(e, btn) {
        e.stopPropagation();
        const menu = btn.parentElement.nextElementSibling;
        const isOpen = menu.style.display === 'flex';
        document.querySelectorAll('.color-menu').forEach(m => m.style.display = 'none');
        menu.style.display = isOpen ? 'none' : 'flex';
    }

    function setTaskColor(dot, colorVar) {
        const item = dot.parentElement.parentElement;
        // 将变量转为实际的 rgb 字符串以便排序对比
        const temp = document.createElement('div');
        temp.style.color = colorVar;
        document.body.appendChild(temp);
        const actualColor = getComputedStyle(temp).color;
        document.body.removeChild(temp);

        item.style.backgroundColor = actualColor;
        dot.parentElement.style.display = 'none';
        sortTasks(); // 变色后立即重排
        saveData();
    }

    function toggleTask(cb) {
        cb.parentElement.classList.toggle('completed', cb.checked);
        sortTasks(); // 勾选后立即重排
        updateCounter();
        saveData();
    }

    function removeTask(btn) { btn.parentElement.parentElement.remove(); updateCounter(); saveData(); }

    function saveData() {
        const todos = [];
        document.querySelectorAll('.todo-item').forEach(item => {
            todos.push({
                text: item.querySelector('.todo-text').innerText,
                done: item.querySelector('input').checked,
                color: item.style.backgroundColor
            });
        });
        localStorage.setItem('my_task_v3', JSON.stringify({ 
            title: mainTitle.innerText, 
            tasks: todos,
            lastDate: getTodayStr()
        }));
    }

    function loadData() {
        const dataStr = localStorage.getItem('my_task_v3');
        if (!dataStr) return;
        const data = JSON.parse(dataStr);
        const today = getTodayStr();
        mainTitle.innerText = data.title || "TASKS";
        document.title = mainTitle.innerText;
        list.innerHTML = '';
        if (data.lastDate !== today) {
            data.tasks.forEach(t => { if (!t.done) createTodoElement(t.text, false, t.color); });
            saveData();
        } else {
            data.tasks.forEach(t => createTodoElement(t.text, t.done, t.color));
        }
        sortTasks();
        updateCounter();
    }

    window.onclick = () => document.querySelectorAll('.color-menu').forEach(m => m.style.display = 'none');
</script>
</body>
</html>
